# SetWinEventHook

[Original Documentation](https://learn.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-setwineventhook)

# SetWinEventHook function (winuser.h)

Sets an event hook function for a range of events.

## Syntax

```
HWINEVENTHOOK SetWinEventHook(
  [in] DWORD        eventMin,
  [in] DWORD        eventMax,
  [in] HMODULE      hmodWinEventProc,
  [in] WINEVENTPROC pfnWinEventProc,
  [in] DWORD        idProcess,
  [in] DWORD        idThread,
  [in] DWORD        dwFlags
);
```

## Parameters

`[in] eventMin`

Type: **[UINT](/en-us/windows/desktop/WinProg/windows-data-types)**

Specifies the [event constant](/en-us/windows/desktop/WinAuto/event-constants) for the lowest event value in the range of events that are handled by the hook function. This parameter can be set to **EVENT\_MIN** to indicate the lowest possible event value.

`[in] eventMax`

Type: **[UINT](/en-us/windows/desktop/WinProg/windows-data-types)**

Specifies the event constant for the highest event value in the range of events that are handled by the hook function. This parameter can be set to [EVENT\_MAX](/en-us/windows/desktop/WinAuto/event-constants) to indicate the highest possible event value.

`[in] hmodWinEventProc`

Type: **[HMODULE](/en-us/windows/desktop/WinProg/windows-data-types)**

Handle to the DLL that contains the hook function at *lpfnWinEventProc*, if the WINEVENT\_INCONTEXT flag is specified in the *dwFlags* parameter. If the hook function is not located in a DLL, or if the WINEVENT\_OUTOFCONTEXT flag is specified, this parameter is **NULL**.

`[in] pfnWinEventProc`

Type: **WINEVENTPROC**

Pointer to the event hook function. For more information about this function, see [WinEventProc](/en-us/windows/desktop/api/winuser/nc-winuser-wineventproc).

`[in] idProcess`

Type: **[DWORD](/en-us/windows/desktop/WinProg/windows-data-types)**

Specifies the ID of the process from which the hook function receives events. Specify zero (0) to receive events from all processes on the current desktop.

`[in] idThread`

Type: **[DWORD](/en-us/windows/desktop/WinProg/windows-data-types)**

Specifies the ID of the thread from which the hook function receives events. If this parameter is zero, the hook function is associated with all existing threads on the current desktop.

`[in] dwFlags`

Type: **[UINT](/en-us/windows/desktop/WinProg/windows-data-types)**

Flag values that specify the location of the hook function and of the events to be skipped. The following flags are valid:

| Value | Meaning |
| --- | --- |
| **WINEVENT\_INCONTEXT** | The DLL that contains the callback function is mapped into the address space of the process that generates the event. With this flag, the system sends event notifications to the callback function as they occur. The hook function must be in a DLL when this flag is specified. This flag has no effect when both the calling process and the generating process are not 32-bit or 64-bit processes, or when the generating process is a console application. For more information, see [In-Context Hook Functions](/en-us/windows/desktop/WinAuto/in-context-hook-functions). |
| **WINEVENT\_OUTOFCONTEXT** | The callback function is not mapped into the address space of the process that generates the event. Because the hook function is called across process boundaries, the system must queue events. Although this method is asynchronous, events are guaranteed to be in sequential order. For more information, see [Out-of-Context Hook Functions](/en-us/windows/desktop/WinAuto/out-of-context-hook-functions). |
| **WINEVENT\_SKIPOWNPROCESS** | Prevents this instance of the hook from receiving the events that are generated by threads in this process. This flag does not prevent threads from generating events. |
| **WINEVENT\_SKIPOWNTHREAD** | Prevents this instance of the hook from receiving the events that are generated by the thread that is registering this hook. |

The following flag combinations are valid:

* WINEVENT\_INCONTEXT | WINEVENT\_SKIPOWNPROCESS
* WINEVENT\_INCONTEXT | WINEVENT\_SKIPOWNTHREAD
* WINEVENT\_OUTOFCONTEXT | WINEVENT\_SKIPOWNPROCESS
* WINEVENT\_OUTOFCONTEXT | WINEVENT\_SKIPOWNTHREAD

Additionally, client applications can specify WINEVENT\_INCONTEXT, or WINEVENT\_OUTOFCONTEXT alone.

See Remarks section for information on Windows Store app development.

## Return value

Type: **HWINEVENTHOOK**

If successful, returns an [HWINEVENTHOOK](/en-us/windows/desktop/WinAuto/hwineventhook) value that identifies this event hook instance. Applications save this return value to use it with the [UnhookWinEvent](/en-us/windows/desktop/api/winuser/nf-winuser-unhookwinevent) function.

If unsuccessful, returns zero.

## Remarks

This function allows clients to specify which processes and threads they are interested in.

If the *idProcess* parameter is nonzero and *idThread* is zero, the hook function receives the specified events from all threads in that process. If the *idProcess* parameter is zero and *idThread* is nonzero, the hook function receives the specified events only from the thread specified by *idThread*. If both are zero, the hook function receives the specified events from all threads and processes.

Clients can call **SetWinEventHook** multiple times if they want to register additional hook functions or listen for additional events.

The client thread that calls **SetWinEventHook** must have a message loop in order to receive events.

When you use **SetWinEventHook** to set a callback in managed code, you should use the [GCHandle](/en-us/dotnet/api/system.runtime.interopservices.gchandle) structure to avoid exceptions. This tells the garbage collector not to move the callback.

For out-of-context events, the event is delivered on the same thread that called **SetWinEventHook**. In some situations, even if you request WINEVENT\_INCONTEXT events, the events will still be delivered out-of-context. These scenarios include events from console windows and events from processes that have a different bit-depth (64 bit versus 32 bits) than the caller.

While a hook function processes an event, additional events may be triggered, which may cause the hook function to reenter before the processing for the original event is finished. The problem with reentrancy in hook functions is that events are completed out of sequence unless the hook function handles this situation. For more information, see [Guarding Against Reentrancy](/en-us/windows/desktop/WinAuto/guarding-against-reentrancy-in-hook-functions).

**Windows Store app development** If dwFlags is WINEVENT\_INCONTEXT AND (idProcess = 0 | idThread = 0), then window hook DLLs are not loaded in-process for the Windows Store app processes and the Windows Runtime broker process unless they are installed by UIAccess processes (accessibility tools). The notification is delivered on the installer's thread.

This behavior is similar to what happens when there is an architecture mismatch between the hook DLL and the target application process, for example, when the hook DLL is 32-bit and the application process 64-bit.

#### Examples

The following example code shows how a client application might listen for menu-start and menu-end events. For simplicity, the event handler just sends some information to the standard output.

```
// Global variable.
HWINEVENTHOOK g_hook;

// Initializes COM and sets up the event hook.
//
void InitializeMSAA()
{
    CoInitialize(NULL);
    g_hook = SetWinEventHook(
        EVENT_SYSTEM_MENUSTART, EVENT_SYSTEM_MENUEND,  // Range of events (4 to 5).
        NULL,                                          // Handle to DLL.
        HandleWinEvent,                                // The callback.
        0, 0,              // Process and thread IDs of interest (0 = all)
        WINEVENT_OUTOFCONTEXT | WINEVENT_SKIPOWNPROCESS); // Flags.
}

// Unhooks the event and shuts down COM.
//
void ShutdownMSAA()
{
    UnhookWinEvent(g_hook);
    CoUninitialize();
}

// Callback function that handles events.
//
void CALLBACK HandleWinEvent(HWINEVENTHOOK hook, DWORD event, HWND hwnd, 
                             LONG idObject, LONG idChild, 
                             DWORD dwEventThread, DWORD dwmsEventTime)
{
    IAccessible* pAcc = NULL;
    VARIANT varChild;
    HRESULT hr = AccessibleObjectFromEvent(hwnd, idObject, idChild, &pAcc, &varChild);  
    if ((hr == S_OK) && (pAcc != NULL))
    {
        BSTR bstrName;
        pAcc->get_accName(varChild, &bstrName);
        if (event == EVENT_SYSTEM_MENUSTART) 
        {
            printf("Begin: ");
        }
        else if (event == EVENT_SYSTEM_MENUEND)
        {
            printf("End:   ");
        }
        printf("%S\n", bstrName);
        SysFreeString(bstrName);
        pAcc->Release();
    }
}
```

## Requirements

| Requirement | Value |
| --- | --- |
| **Minimum supported client** | Windows 2000 Professional [desktop apps only] |
| **Minimum supported server** | Windows Server 2003 [desktop apps only] |
| **Target Platform** | Windows |
| **Header** | winuser.h (include Windows.h) |
| **Library** | User32.lib |
| **DLL** | User32.dll |
| **Redistributable** | Active Accessibility 1.3 RDK on Windows NT 4.0 with SP6 and later and Windows 95 |

## See also

[Registering a Hook Function](/en-us/windows/desktop/WinAuto/registering-a-hook-function)

[UnhookWinEvent](/en-us/windows/desktop/api/winuser/nf-winuser-unhookwinevent)

[WinEventProc](/en-us/windows/desktop/api/winuser/nc-winuser-wineventproc)

---
